#!/bin/sh
#
# Generate Git config
#

DOTFILES=${1:-${HOME}/.config/dotfiles}
GIT_CONFIG_FILE=${2:-${HOME}/.gitconfig}
GIT_CONFIG_CMD="git config --file ${GIT_CONFIG_FILE}"

gc_set() {
  ${GIT_CONFIG_CMD} "${1}" "${2}"
}

gc_unset() {
  ${GIT_CONFIG_CMD} --unset "${1}"
}

gc_clear() {
  ${GIT_CONFIG_CMD} --unset-all "${1}"
}

gc_update() {
  gc_unset "${1}"
  if [ -n "${2}" ]; then
    gc_set "${1}" "${2}"
  fi
}

# Prompt for git config key
gc_prompt() {
  local current="$(${GIT_CONFIG_CMD} --get ${1})"
  read -p "${1} (${current}): " input
  gc_update ${1} "${input:-${current}}"
}

echo "Generating gitconfig..."
touch ${GIT_CONFIG_FILE}

# Include defaults and aliases
gc_set include.path ${DOTFILES}/gitconfig

# User info
gc_prompt user.name "User name"
gc_prompt user.email "Email"

# Use Git Credential Manager if it is installed
if [ -x "$(command -v git-credential-manager)" ]; then
  gc_clear credential.helper
  git-credential-manager configure
else
  gc_clear credential.helper
  case $(uname) in
  Darwin ) gc_set credential.helper osxkeychain ;;
  Linux  ) gc_set credential.helper cache ;;
  esac
fi


# Set configuration by platform
case $(uname) in
Darwin )
  # BBEdit diff
  if [ -x "$(command -v bbdiff)" ]; then
    gc_set difftool."bbdiff".cmd 'bbdiff --wait --resume $LOCAL $REMOTE'
  fi

  # Kaleidoscope
  if [ -x "$(command -v ksdiff)" ]; then
    gc_set difftool."Kaleidoscope".cmd 'ksdiff --partial-changeset --relative-path $MERGED -- $LOCAL $REMOTE'
    gc_set mergetool."Kaleidoscope".cmd 'ksdiff --merge --output $MERGED --base $BASE -- $LOCAL --snapshot $REMOTE --snapshot'
    gc_set mergetool."Kaleidoscope".trustExitCode true
  fi

  # Use opendiff as default diff/merge
  gc_set diff.tool opendiff
  gc_set merge.tool opendiff

  # Use fork for visual
  gc_set alias.visual '!fork $(git root)'
  ;;
Linux )
  # Check for WSL
  if [ -n "${WSL_DISTRO_NAME}" ]; then
    # Use Fork for visual
    gc_set alias.visual '!Fork.exe $(wslpath -w $(git root))'
  fi

  # Use Vim as default diff/merge
  gc_set diff.tool vimdiff
  gc_set merge.tool vimdiff
  ;;
esac
